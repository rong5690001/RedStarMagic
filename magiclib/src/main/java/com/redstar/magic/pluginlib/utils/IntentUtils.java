package com.redstar.magic.pluginlib.utils;import android.content.ComponentName;import android.content.Context;import android.content.Intent;import android.content.pm.ActivityInfo;import android.text.TextUtils;import com.redstar.magic.pluginlib.PluginApk;import com.redstar.magic.pluginlib.components.MagicContext;import com.redstar.magic.pluginlib.exception.ActivityPoolException;import com.redstar.magic.pluginlib.exception.PluginNotInstalled;import com.redstar.magic.pluginlib.pm.PluginManager;import com.redstar.magic.pluginlib.pool.ActivityPool;/** * Created by chen.huarong on 2019-11-11. * intent工具类，启动组件，转换intent */public class IntentUtils {    private static final String TAG = IntentUtils.class.getSimpleName();    public static String KEY_PLUGIN_PACKAGE_NAME = "plugin_packge_name";    public static String KEY_CLASS_NAME = "class_name";    /**     * 根据intent获取包名     *     * @param intent     * @return     */    public static String getPackageName(Intent intent) {        if (intent.getComponent() != null) {            return intent.getComponent().getPackageName();        }        return "";    }    /**     * 宿主启动插件Activity     *     * @param context     * @param intent     */    public static boolean startActivity(Context context, Intent intent) {        intent.putExtra(KEY_PLUGIN_PACKAGE_NAME, getPackageName(intent));        try {            context.startActivity(transformIntentActivity(context, intent));            return true;        } catch (ActivityPoolException | PluginNotInstalled e) {            e.printStackTrace();            return false;        }    }    /**     * 插件启动插件Activity     *     * @param context     * @param intent     */    public static boolean startActivity(MagicContext context, Intent intent) {        intent.putExtra(KEY_PLUGIN_PACKAGE_NAME, getPackageName(intent));        try {            context.superStartActivity(transformIntentActivity(context.getBaseContext(), intent));            return true;        } catch (ActivityPoolException | PluginNotInstalled e) {            e.printStackTrace();            return false;        }    }    /**     * 转换Intent为启动代理Activity     *     * @param context     * @param originalIntent     * @return     */    private static Intent transformIntentActivity(Context context, Intent originalIntent) throws ActivityPoolException, PluginNotInstalled {        Intent intentProxy = new Intent(originalIntent);        ComponentName componentName = intentProxy.getComponent();        if (componentName == null) {            throw new NullPointerException("component is null!!!");        }        String packageName = componentName.getPackageName();        if (TextUtils.isEmpty(packageName)) {            throw new NullPointerException("packageName is null!!!");        }        intentProxy.setExtrasClassLoader(PluginManager.getInstance().getPluginApk(packageName).mClassLoader);        intentProxy.putExtra(KEY_CLASS_NAME, componentName.getClassName());        //获取占坑ActivityName        String placeHolderActivity = "";        PluginApk pluginApk =                PluginManager.getInstance().getPluginApk(componentName.getPackageName());        for (ActivityInfo activity : pluginApk.mPackageInfo.activities) {            if (TextUtils.equals(componentName.getClassName(), activity.name)) {                placeHolderActivity = ActivityPool.getActivity(activity.name, activity.launchMode);            }        }        intentProxy.setComponent(new ComponentName(context, placeHolderActivity));        return intentProxy;    }//    /**//     * 获取占坑ActivityName//     * <p>//     * 根据activity启动模式选择不同的占坑Activity//     *//     * @param componentName 真正要启动的activity的componentName//     * @return 占坑ActivityName//     *///    @NotNull//    private static String getPlaceHolderActivity(@NonNull ComponentName componentName) throws//    ActivityPoolException {//        PluginApk pluginApk =//                PluginManager.getInstance().getPluginApk(componentName.getPackageName());//        for (ActivityInfo activity : pluginApk.mPackageInfo.activities) {//            if (TextUtils.equals(componentName.getClassName(), activity.name)) {//                return ActivityPool.getActivity(activity.name, activity.launchMode);//            }//        }////        throw new ActivityPoolException(" Unable to find explicit activity class " +//        componentName.getClassName() + "; have you declared this activity in your//        AndroidManifest.xml?");//    }}