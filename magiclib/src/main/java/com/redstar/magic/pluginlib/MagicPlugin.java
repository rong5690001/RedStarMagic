package com.redstar.magic.pluginlib;import android.content.ComponentName;import android.content.Context;import android.content.Intent;import com.redstar.magic.pluginlib.pm.PluginManager;import com.redstar.magic.pluginlib.proxy.PluginProxyActivity;import com.redstar.magic.pluginlib.tools.Logger;import static com.redstar.magic.pluginlib.IPluginComponentLauncher.KEY_CLASS_NAME;import static com.redstar.magic.pluginlib.IPluginComponentLauncher.KEY_PLUGIN_NAME;/** * Created by chen.huarong on 2019-06-27. * 插件框架对宿主暴露的接口 */public class MagicPlugin {    private static final String TAG = MagicPlugin.class.getSimpleName();    public static void install(Context context) {        PluginApplication.install(context);    }    //    /**//     * hook系统ClassLoader//     *//     * @param base//     *///    static void hook(Context base) {//        try {//            // 获取mBase.mPackageInfo//            // 1. ApplicationContext - Android 2.1//            // 2. ContextImpl - Android 2.2 and higher//            // 3. AppContextImpl - Android 2.2 and higher//            Object mPackInfo = ReflectUtils.readField(base, "mPackageInfo");//            // 获取mPackageInfo.mClassLoader//            ClassLoader mSystemClassLoader = (ClassLoader) ReflectUtils.readField(mPackInfo,//                    "mClassLoader");////            //创建替你系统的ClassLoader//            ClassLoader npClassLoader = new NiceMainClassLoader(mSystemClassLoader);//            // 将新的ClassLoader写入mPackageInfo.mClassLoader////            ReflectUtils.writeField(mPackInfo, "mClassLoader", npClassLoader);//        } catch (Throwable e) {//            e.printStackTrace();//        }//    }    /**     * 启动插件Activity     *     * @param context     * @param pkg     * @param intent     */    @Deprecated    public static boolean startActivity(Context context, String pkg, Intent intent) {        //插件是否安装 || 安装成功 -> 是否安装?安装成功:true        ComponentName componentName = intent.getComponent();        intent.putExtra(KEY_PLUGIN_NAME, pkg);        if (isLoaded(pkg) || loadPlugin(pkg)) {            context.startActivity(transformIntent(context, intent));            return true;        }        Logger.e(TAG, "插件{ %s }的activity{ %s } 启动失败", pkg, componentName.getClassName());        return false;    }    /**     * 启动插件Activity     *     * @param context     * @param pkg     * @param intent     */    @Deprecated    public static boolean startActivity2(Context context, String pkg, Intent intent) {        //插件是否安装 || 安装成功 -> 是否安装?安装成功:true        ComponentName componentName = intent.getComponent();        boolean result = loadPlugin(pkg);        if (!result) {            Logger.e(TAG, "插件{ %s }的activity{ %s } 启动失败", pkg, componentName.getClassName());            return false;        }        intent.putExtra(KEY_PLUGIN_NAME, pkg);        context.startActivity(transformIntent(context, intent));        return true;    }    /**     * 转换Intent为启动代理Activity     *     * @param context     * @param intent     * @return     */    private static Intent transformIntent(Context context, Intent intent) {        Intent intentProxy = new Intent(intent);        intentProxy.setExtrasClassLoader(PluginManager.getInstance().getPluginApk(intent.getComponent().getPackageName()).mClassLoader);        intentProxy.putExtra(KEY_CLASS_NAME, intent.getComponent().getClassName());        intentProxy.setComponent(new ComponentName(context, PluginProxyActivity.class.getName()));        return intentProxy;    }    /**     * 安装插件     *     * @param pluginName     */    protected static boolean loadPlugin(String pluginName) {        if (PluginManager.getInstance().loadApk(pluginName, false)) {            return true;        } else {            Logger.e(TAG, "插件{ %s }安装失败", pluginName);            return false;        }    }    protected static boolean isLoaded(String pkg) {        return PluginManager.getInstance().isLoaded(pkg);    }}